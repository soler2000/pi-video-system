<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Pi Video System â€” Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}">
  <style>
    /* minimal layout helpers in case app.css is missing anything */
    :root { color-scheme: dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    header { display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid #333; }
    .brand { font-weight:600; letter-spacing:.2px; }
    .actions a { display:inline-block; margin-left:8px; padding:8px 12px; border:1px solid #444; border-radius:8px; text-decoration:none; color:inherit; }
    .container { padding:16px; max-width:1100px; margin:0 auto; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; }
    .card { background:#111; border:1px solid #2a2a2a; border-radius:12px; padding:14px; }
    .card-title { font-size:.9rem; opacity:.8; margin-bottom:6px; }
    .card-value { font-size:1.6rem; font-weight:600; }
    .sub { font-size:.9rem; opacity:.8; margin-top:6px; }
    .muted { opacity:.65; }
    .status { display:flex; align-items:center; gap:8px; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; background:#555; }
    .dot.ok { background:#14b86a; }
    .dot.err { background:#e23b3b; }
    footer { padding:14px 16px; border-top:1px solid #333; font-size:.9rem; opacity:.75; }
    @media (pointer:coarse) {
      .card-value { font-size:1.8rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">ðŸ“Š Dashboard</div>
    <div class="status">
      <span id="liveDot" class="dot"></span>
      <span id="liveText" class="muted">connectingâ€¦</span>
    </div>
    <nav class="actions">
      <a href="{{ url_for('index') }}">Home</a>
      <a href="{{ url_for('reverse') }}">Reversing Cam</a>
      <a href="{{ url_for('settings_led') }}">LED Settings</a>
    </nav>
  </header>

  <main class="container">
    <div class="grid">
      <div class="card">
        <div class="card-title">Distance</div>
        <div class="card-value"><span id="distance_val">â€”</span></div>
        <div class="sub">meters (shows &gt;4.0 m when beyond range)</div>
      </div>

      <div class="card">
        <div class="card-title">Battery</div>
        <div class="card-value"><span id="battery_percent">â€”</span></div>
        <div class="sub">Voltage: <span id="battery_voltage">â€”</span></div>
      </div>

      <div class="card">
        <div class="card-title">CPU</div>
        <div class="card-value"><span id="cpu_load">â€”</span></div>
        <div class="sub">Temp: <span id="cpu_temp">â€”</span></div>
      </div>

      <div class="card">
        <div class="card-title">Wi-Fi Signal</div>
        <div class="card-value"><span id="wifi_dbm">â€”</span></div>
        <div class="sub muted">RSSI (dBm)</div>
      </div>
    </div>

    <div class="sub" style="margin-top:10px;">
      Last update: <span id="last_update">â€”</span>
    </div>
  </main>

  <footer>
    Pi Video System â€” Live stats refresh every 1s. No caching applied to API calls.
  </footer>

  <script>
    (function(){
      const $ = (id) => document.getElementById(id);

      function setText(id, value){
        const el = $(id);
        if (el) el.textContent = value;
      }

      function fmtMeters(s){
        // s can be number (meters) or string like ">4.0"
        if (s === null || s === undefined) return 'â€”';
        if (typeof s === 'number') return s.toFixed(2) + ' m';
        if (typeof s === 'string') {
          // ensure we show the " m" suffix for strings like ">4.0"
          return s.endsWith('m') ? s : (s + ' m');
        }
        return 'â€”';
      }

      function setLiveState(ok){
        const dot = $('liveDot'), txt = $('liveText');
        if (!dot || !txt) return;
        if (ok){ dot.className = 'dot ok'; txt.textContent = 'live'; }
        else    { dot.className = 'dot err'; txt.textContent = 'error'; }
      }

      function tsNow(){
        try{
          return new Date().toLocaleTimeString();
        }catch(e){ return ''; }
      }

      async function refreshStats(){
        try{
          const r = await fetch('/api/stats?ts=' + Date.now(), { cache: 'no-store' });
          const s = await r.json();

          // Distance (prefer distance_m; fall back to distance_cm/100)
          let m = (s.distance_m !== undefined) ? s.distance_m : null;
          if (m === null || m === undefined){
            if (typeof s.distance_cm === 'number'){
              m = (s.distance_cm / 100).toFixed(2) + ' m';
            } else {
              m = 'â€”';
            }
          } else {
            m = fmtMeters(m);
          }
          setText('distance_val', m);

          // Battery
          if (s.battery){
            if (typeof s.battery.percent === 'number'){
              setText('battery_percent', s.battery.percent.toFixed(0) + '%');
            } else setText('battery_percent', 'â€”');

            if (typeof s.battery.voltage === 'number'){
              setText('battery_voltage', s.battery.voltage.toFixed(2) + ' V');
            } else setText('battery_voltage', 'â€”');
          } else {
            setText('battery_percent', 'â€”');
            setText('battery_voltage', 'â€”');
          }

          // CPU
          if (typeof s.cpu_load === 'number') setText('cpu_load', s.cpu_load.toFixed(0) + ' %');
          else setText('cpu_load', 'â€”');

          if (typeof s.cpu_temp === 'number') setText('cpu_temp', s.cpu_temp.toFixed(1) + ' Â°C');
          else setText('cpu_temp', 'â€”');

          // Wi-Fi
          if (typeof s.wifi_dbm === 'number') setText('wifi_dbm', s.wifi_dbm + ' dBm');
          else setText('wifi_dbm', 'â€”');

          // Status + last update
          setLiveState(true);
          setText('last_update', tsNow());
        } catch (e){
          setLiveState(false);
        }
      }

      // hard no-cache for any API reply (defense in depth if server forgets headers)
      if ('caches' in window) {
        try { caches.delete('v'); } catch(e){}
      }

      setInterval(refreshStats, 1000);
      refreshStats();
    })();
  </script>
</body>
</html>